#!/usr/bin/env python3
import configparser
import shlex
import subprocess
import sys

CONFIG_FILE = "/etc/sanoid/syncoidd.conf"

def main(config_file=CONFIG_FILE):
  exit_code = 0
  config = configparser.ConfigParser(interpolation=None)
  config.read(config_file)
  global_flags = shlex.split(config.get("global", "flags", fallback="").strip())
  for section_name in config.sections():
    if section_name.lower() == "global": continue
    source = config[section_name].get("source", section_name).strip()
    target = config[section_name].get("target", section_name).strip()
    if source == target: continue
    flags = shlex.split(config[section_name].get("flags", "").strip())
    print(f"------: {source} -> {target} [{' '.join(global_flags + flags)}]", flush=True)
    cmd = ['syncoid'] + global_flags + flags + [source, target]
    process = subprocess.run(cmd)
    if process.returncode != 0:
      print(f"FAILED: exit code {process.returncode}", flush=True)
      exit_code = 1
  return exit_code

if __name__ == "__main__":
  sys.exit(main(sys.argv[1] if len(sys.argv) > 1 else CONFIG_FILE))
